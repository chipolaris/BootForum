<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:c="http://java.sun.com/jsp/jstl/core"
      xmlns:jsf="http://xmlns.jcp.org/jsf"
      xmlns:fn="http://java.sun.com/jsp/jstl/functions"
      xmlns:sec="http://www.springframework.org/security/tags">

    <h:head>
        <f:facet name="first">
            <meta http-equiv="X-UA-Compatible" content="IE=edge" />
            <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
            <meta name="apple-mobile-web-app-capable" content="yes" />
        </f:facet>
        <title><ui:insert name="title">#{msg['application.title']}</ui:insert></title>
        
        <!-- *Note: favicon generated and setup instruction taken from https://favicon.io/favicon-generator/ -->
		<link rel="apple-touch-icon" sizes="180x180" href="#{request.contextPath}/favicon_io/apple-touch-icon.png"/>
		<link rel="icon" type="image/png" sizes="32x32" href="#{request.contextPath}/favicon_io/favicon-32x32.png"/>
		<link rel="icon" type="image/png" sizes="16x16" href="#{request.contextPath}/favicon_io/favicon-16x16.png"/>
		<link rel="manifest" href="#{request.contextPath}/favicon_io/site.webmanifest"/>
        
        <h:outputStylesheet library="css" name="w3.css"/>
        <h:outputScript library="js" name="app/timeAgoLocale.js"/>
        
        <!-- color themes -->
        <!-- read from cookie name 'theme.color', if empty read from #{systemInfo.displayOption.themeColor}, 
        	if still empty, set to default value 'w3-theme-light-blue' -->
        <c:set var = "theme_color" value = "#{cookie['theme.color'].value}"/>
        
        <c:if test = "#{empty theme_color}">
        	
        	<c:set var = "theme_color" value = "#{systemInfo.displayOption.themeColor}"/>
        	        	
        	<c:if test = "#{empty theme_color}">
        		<c:set var = "theme_color" value = "w3-theme-light-blue"/>
      		</c:if> 
      	</c:if>     	
        <h:outputStylesheet library="css" name="w3-theme/#{theme_color}.css"/>
        
        <style>
        	
        	html {scroll-behavior: smooth;}
        	
			html, body, h1, h2, h3, h4, h5 {font-family: Helvetica, Arial, sans-serif;}
			a { text-decoration: none }
			a:link           { color: #339966 } 
			a:visited        { color: #C92D99 } 
			a:hover, a:focus { color: #990000 } 
			a:active         { color: #339966 }  
			
			input[type=text].searchInput {
			  
			  box-sizing: border-box;
			  border: 2px solid #ccc;
			  border-radius: 4px;
			  font-size: 14px;
			  background-color: white;
			  background-image: url('#{resource['images/searchicon.png']}');
			  background-position: 10px 10px; 
			  background-repeat: no-repeat;
			  padding: 10px 20px 8px 35px;
			  -webkit-transition: width 0.4s ease-in-out;
			  transition: width 0.4s ease-in-out;
			}
			
			input[type=text].searchInputExpand {
				width: 200px;
			}
			
			input[type=text].searchInputExpand:focus {
			  width: 400px;
			}
			
			/* primefaces p:password tag toggleMask="true" will add a span, so make the span full width */
			span.ui-password {
				display:block;
			}
			
			body .ui-breadcrumb {
				border-style: none;
			}			

		</style>
		
		<script>
			//<![CDATA[
			
			$(document).ready(function(){
				changeAvatarBackgrounds();
			});
			
			function changeAvatarBackgrounds() {
				$(".avatarSpan").each(function() {						
					$(this).css('background-color', stringToColor($(this).prop('title')));
				});
			}
				
			function openNav(elementId) {
			  var elm = document.getElementById(elementId);
			  if (elm.className.indexOf("w3-show") == -1) {
			    elm.className += " w3-show";
			  } else { 
			    elm.className = elm.className.replace(" w3-show", "");
			  }
			}	
				
			function showSearchSuggestion(keywordInput, searchValueEl, searchCommentLinkEl, elementId, doSearch = true) {
				
				var elm = document.getElementById(elementId);
				var keywords = keywordInput.value;
				
				if (keywords.length >= 3) {
					
					if(elm.className.indexOf("w3-show") == -1)
						elm.className += " w3-show";
					
					if(doSearch) {
						invokeSearchSuggestion([{name: 'keywords', value: keywords}]);					
					}
					
					var searchValueElement = document.getElementById(searchValueEl);
					searchValueElement.textContent = keywords;
					
					var searchCommentLink = document.getElementById(searchCommentLinkEl);
					searchCommentLink.href = "#{request.contextPath}/searchComment.xhtml?keywords=" + keywords;
				} 
				else { 
					elm.className = elm.className.replace(" w3-show", "");
				}
			}
			
			/* 
			 * debounce function to prevent exessive invokations, 
			 *	ex: prevent code to be unecessarily invoked multiple times (such as hooked up to onkeyup event on textInput) 
			 * https://www.freecodecamp.org/news/javascript-debounce-example/
			 */ 
			function debounce(func, timeout = 300){
				let timer;
			  	return (...args) => {
			    	clearTimeout(timer);
			    	timer = setTimeout(() => { func.apply(this, args); }, timeout);
			    };
			}		
			
			/*
			 * 	utilize the debounce function above to prevent exessive server calls on search suggestions:
			 * 	 Only invoke the showSearchSuggestion after 300 miliseonds of last keyup
			 */
			const debounceSearchSuggestion = debounce((keywordInput, searchValueEl, searchCommentLinkEl, elementId) => 
				{ showSearchSuggestion(keywordInput, searchValueEl, searchCommentLinkEl, elementId) }, 300);
			
			function hideSearchSuggestion(elementId) {
				var elm = document.getElementById(elementId);
				elm.className = elm.className.replace(" w3-show", "");
			}
			
			// from https://stackoverflow.com/questions/3426404/create-a-hexadecimal-colour-based-on-a-string-with-javascript
			function stringToColor(str) {
				var hash = 0;
				for (var i = 0; i < str.length; i++) {
					hash = str.charCodeAt(i) + ((hash << 5) - hash);
				}
				var colour = '#';
				for (var i = 0; i < 3; i++) {
					var value = (hash >> (i * 8)) & 0xFF;
				    colour += ('00' + value.toString(16)).substr(-2);
				}
				return colour;
			}
			//]]>	
		</script>
    </h:head>

    <h:body style="margin:0px;background-color: #e8e8e8">
    	
    	<h:form>
    		<p:remoteCommand name="invokeSearchSuggestion" update="searchSuggestionResultDiv searchSuggestionResultDivSmall" action="#{searchSuggestion.suggest}"/>
    	</h:form>

		<!-- navbar -->
		<div class="w3-top w3-theme-l5">
			<div class="w3-bar w3-left-align w3-card" style="max-height: 60px;">
				<div style="max-width:1680px;margin:auto;">
					
					<!-- ellipsis icon button to show on small screen -->
					<a class="w3-bar-item w3-button w3-hide-medium w3-hide-large w3-hover-text-white w3-border-left w3-right" href="javascript:void(0);" onclick="openNav('navSmall')" 
						style="font-size:28px;padding-top:9px;padding-bottom: 9px;">
						<i class="pi pi-ellipsis-v w3-xlarge"/>
					</a>
					
					<a href="#{request.contextPath}" class="w3-bar-item w3-theme-gradient-l1" style="padding:0">
						<!-- <img src="#{resource['images/logo.png']}" alt="Home" style="height: 44px;" title="#{msg['home']}"/> -->
						<img src="#{request.contextPath}/resources/images/logo.png" alt="Home" style="height: 60px;" title="#{msg['home']}"/>
					</a>
					
					<!-- medium screen top menu items -->
					<a href="#{request.contextPath}/forums.xhtml" class="w3-bar-item w3-button w3-hide-small w3-hide-large w3-hover-grey w3-hover-text-white w3-text-dark-gray" 
						style="font-size:1.40rem;padding:15px 14px 14px 14px;" title="#{msg['forums']}">
						<i class="pi pi-list w3-xlarge"/>
					</a>
					<a href="#{request.contextPath}/chat/index.xhtml" class="w3-bar-item w3-button w3-hide-small w3-hide-large w3-hover-grey w3-hover-text-white w3-text-dark-gray" 
						style="font-size:1.40rem;padding:15px 14px 14px 14px;" title="#{msg['chat.rooms']}">
						<i class="pi pi-comments w3-xlarge"/>
					</a>
					<a href="#{request.contextPath}/listMembers.xhtml" class="w3-bar-item w3-button w3-hide-small w3-hide-large w3-hover-grey w3-hover-text-white w3-text-dark-gray" 
						style="font-size:1.40rem;padding:15px 14px 14px 14px;" title="#{msg['members']}">
						<i class="pi pi-users w3-xlarge"/>
					</a>
					
					<sec:authorize ifAnyGranted="ROLE_ANONYMOUS">
						<a href="javascript:void(0);" class="w3-bar-item w3-button w3-hide-small w3-hide-large w3-hover-grey w3-hover-text-white w3-text-dark-gray"
							style="font-size:1.40rem;padding:15px 14px 14px 14px;" title="#{msg['register']}" onclick="document.getElementById('registerModal').style.display='block'">
							<i class="pi pi-book w3-xlarge"/>
						</a>					
						<a href="javascript:void(0);" class="w3-bar-item w3-button w3-hide-small w3-hide-large w3-hover-grey w3-hover-text-white w3-text-dark-gray"
							style="font-size:1.40rem;padding:15px 14px 14px 14px;" title="#{msg['login']}" onclick="document.getElementById('loginModal').style.display='block'">
							<i class="pi pi-sign-in w3-xlarge"/>
						</a>
					</sec:authorize>
					
					<!-- large screen top menu items -->
					<a href="#{request.contextPath}/forums.xhtml" class="w3-bar-item w3-button w3-hide-small w3-hide-medium w3-hover-grey w3-hover-text-white w3-text-dark-gray">
						<i class="pi pi-list w3-xlarge"/><br/><span class="w3-medium">#{msg['forums']}</span>
					</a>
					<a href="#{request.contextPath}/chat/index.xhtml" class="w3-bar-item w3-button w3-hide-small w3-hide-medium w3-hover-grey w3-hover-text-white w3-text-dark-gray">
						<i class="pi pi-comments w3-xlarge"/><br/><span class="w3-medium">#{msg['chat.rooms']}</span>
					</a>
					<a href="#{request.contextPath}/listMembers.xhtml" class="w3-bar-item w3-button w3-hide-small w3-hide-medium w3-hover-grey w3-hover-text-white w3-text-dark-gray">
						<i class="pi pi-users w3-xlarge"/><br/><span class="w3-medium">#{msg['members']}</span>
					</a>
					
					<sec:authorize ifAnyGranted="ROLE_ANONYMOUS">
					
						<a href="javascript:void(0);" class="w3-bar-item w3-button w3-hide-small w3-hide-medium w3-hover-grey w3-hover-text-white w3-text-dark-gray"
							onclick="document.getElementById('registerModal').style.display='block'">
							<i class="pi pi-book w3-xlarge"/><br/><span class="w3-medium">#{msg['register']}</span>
						</a>					
						<a href="javascript:void(0);" class="w3-bar-item w3-button w3-hide-small w3-hide-medium w3-hover-grey w3-hover-text-white w3-text-dark-gray" 
							onclick="document.getElementById('loginModal').style.display='block'">
							<i class="pi pi-sign-in w3-xlarge"/><br/><span class="w3-medium">#{msg['login']}</span>
						</a>
					
					</sec:authorize>
					
					<!-- if logged in, show the profile image on all three screen sizes: small, medium, and large -->
					<sec:authorize ifNotGranted="ROLE_ANONYMOUS">
						
						<div class="w3-dropdown-hover">
							<button class="w3-button" style="height: 60px;">
								<h:graphicImage value="#{requestContext}/avatar/#{userSession.user.username}" class="w3-circle"
									id="commentorAvatar" height="40" width="40" style="border:3px;" title="#{userSession.user.username}"
									rendered="#{fileHandler.isAvatarExists(userSession.user.username)}"/>
							
								<span jsf:rendered="#{!fileHandler.isAvatarExists(userSession.user.username)}" class="w3-circle avatarSpan"
									title="#{userSession.user.username}"
									style="display:inline-block;font-size:1.0rem;line-height:40px;width:40px;text-align:center;text-transform: uppercase;color:white;">
									#{fn:substring(userSession.user.username, 0, 3)}
								</span>							
							
							</button>
							<div class="w3-dropdown-content w3-bar-block w3-card-4">
								<h:link outcome="/secure/index" styleClass="w3-bar-item w3-button"><i class="pi pi-user"/> #{msg['my.account']}</h:link>
								<a href="#{request.contextPath}/logout" class="w3-bar-item w3-button"><i class="pi pi-sign-out"/> #{msg['logout']}</a>
							</div>
						</div>
						
					</sec:authorize>
					
					<!-- search icon button, show on small screens -->
					<a class="w3-bar-item w3-button w3-border-left w3-hover-text-white w3-hide-medium w3-hide-large w3-right" href="javascript:void(0);" 
						onclick="openNav('searchSmall')" style="font-size:28px;padding-top:9px;padding-bottom: 9px;" title="#{msg['search']}">
						<i class="pi pi-search"/>
					</a>
					
					<!-- search bar, show on large and medium screens -->
					<div class="w3-dropdown-click w3-bar-item w3-right w3-hover-none w3-hide-small" style="margin-top:2px;"> <!-- try the margin-top to vertically align the search div to middle -->
						
						<!-- note: on the onblur event, must use the setTimeout to delay the hideSuggestion function, if not, the a href link won't work when user click on the link -->
						<input type="text" value="#{null}" placeholder="#{msg['search.forum']}.." autocomplete="off"
							class="w3-input w3-border w3-round searchInput searchInputExpand" id="keywords" 
							onkeyup="debounceSearchSuggestion(this, 'searchValue', 'searchCommentLink', 'searchSuggestionDiv');document.getElementById('keywordsSmall').value = this.value;" 
							onfocus="showSearchSuggestion(this, 'searchValue', 'searchCommentLink', 'searchSuggestionDiv', false)" 
							onblur="setTimeout(function(){ hideSearchSuggestion('searchSuggestionDiv'); }, 300);"/>
							
						<div jsf:id="searchSuggestionDiv" class="w3-dropdown-content w3-bar-block w3-border w3-card" style="width:400px;margin-top: 5px;">
						
							<a href="#{request.contextPath}/searchComment.xhtml?keywords=" class="w3-bar-item w3-button" id="searchCommentLink">
								Search comment for <span id="searchValue" style="font-weight: bold"></span>
							</a>
						
							<div jsf:id="searchSuggestionResultDiv">
								<p:dataList value="#{searchSuggestion.discussions}" var="discussion" rendered="#{not empty searchSuggestion.discussions}">
									<f:facet name="header">
							            #{msg['discussions']}:
							        </f:facet>
							        <h:link outcome="/discussion">
										<span>#{discussion.id}: #{discussion.title}</span>
										<f:param name="id" value="#{discussion.id}"/>
									</h:link>
								</p:dataList>
								<p:dataList value="#{searchSuggestion.comments}" var="comment" rendered="#{not empty searchSuggestion.comments}">
									<f:facet name="header">
							            #{msg['comments']}:
							        </f:facet>
							        <h:link outcome="/commentThread">
										<span>#{comment.id}: #{comment.title}</span>
										<f:param name="id" value="#{comment.id}"/>
									</h:link>
								</p:dataList>
								<p:dataList value="#{searchSuggestion.usernames}" var="username" rendered="#{not empty searchSuggestion.usernames}">
									<f:facet name="header">
							            #{msg['members']}:
							        </f:facet>
							        
							        <h:link outcome="/memberProfile">
										<h:graphicImage value="#{requestContext}/avatar/#{username}" class="w3-circle"
											id="commentorAvatar" height="36" width="36"	title="#{username}"
											rendered="#{fileHandler.isAvatarExists(username)}"/>
										
										<span jsf:rendered="#{!fileHandler.isAvatarExists(username)}" class="w3-circle w3-purple"
											 title="#{username}"
		  									style="display:inline-block;font-size:1.0rem;line-height:36px;width:36px;text-align:center;text-transform: uppercase;">
		  									#{fn:substring(username, 0, 3)}
										</span>
										#{username}
										<f:param name="username" value="#{username}"/>
									</h:link>     
								</p:dataList>
							</div>
							
						</div>
					</div>				
					
				</div>
			</div>
		
		  	<!-- Navbar on small screens -->
		  	<div id="navSmall" class="w3-bar w3-theme-l4 w3-hide w3-hide-large w3-hide-medium w3-border-top">
		    	
		    	<a href="#{request.contextPath}/listMembers.xhtml" class="w3-bar-item w3-button w3-hover-grey w3-hover-text-white w3-border-left w3-right"><i class="pi pi-users w3-large"/><br/>Members</a>
		    	<a href="#{request.contextPath}/chat/index.xhtml" class="w3-bar-item w3-button w3-hover-grey w3-hover-text-white w3-border-left w3-right"><i class="pi pi-comments w3-large"/><br/>Chat</a>
		    	<a href="#{request.contextPath}/forums.xhtml" class="w3-bar-item w3-button w3-hover-grey w3-hover-text-white w3-border-left w3-right"><i class="pi pi-list w3-large"/><br/>Forums</a>
		    	
		    	<sec:authorize ifAnyGranted="ROLE_ANONYMOUS">
		    	
		    		<a href="javascript:void(0);" class="w3-bar-item w3-button w3-hover-grey w3-hover-text-white w3-border-left w3-right"
						onclick="document.getElementById('registerModal').style.display='block'">
						<i class="pi pi-book w3-large"/><br/>#{msg['register']}
					</a>					
					<a href="javascript:void(0);" class="w3-bar-item w3-button w3-hover-grey w3-hover-text-white w3-border-left w3-right" 
						onclick="document.getElementById('loginModal').style.display='block'">
						<i class="pi pi-sign-in w3-large"/><br/>#{msg['login']}
					</a>
					
		    	</sec:authorize>
		  	</div>
		  	
		  	<!-- Searchbar on small screens -->
		  	<div id="searchSmall" class="w3-padding w3-theme-l4 w3-hide w3-hide-large w3-hide-medium w3-border-top">
		  	
				<div class="w3-dropdown-click w3-bar-item w3-hover-none w3-block">
					
					<!-- note: on the onblur event, must use the setTimeout to delay the hideSuggestion function, if not, the a href link won't work when user click on the link -->
					<input type="text" value="#{null}" placeholder="#{msg['search.forum']}.." style="width:100%; font-family: Helvetica, Arial, sans-serif, PrimeIcons" autocomplete="off"
						class="w3-input w3-border w3-round searchInput" id="keywordsSmall"
						onkeyup="showSearchSuggestion(this, 'searchValueSmall', 'searchCommentLinkSmall', 'searchSuggestionDivSmall'); document.getElementById('keywords').value = this.value;" 
						onfocus="showSearchSuggestion(this, 'searchValueSmall', 'searchCommentLinkSmall', 'searchSuggestionDivSmall', false)" 
						onblur="setTimeout(function(){ hideSearchSuggestion('searchSuggestionDivSmall'); }, 300);"/>
						
					<div jsf:id="searchSuggestionDivSmall" class="w3-dropdown-content w3-bar-block w3-border w3-card" style="width:100%;margin-top: 5px;">
					
						<a href="#{request.contextPath}/searchComment.xhtml?keywords=" class="w3-bar-item w3-button" id="searchCommentLinkSmall">
							#{msg['search.comment.for']} <span id="searchValueSmall" style="font-weight: bold"></span>
						</a>
					
						<div jsf:id="searchSuggestionResultDivSmall">
							<p:dataList value="#{searchSuggestion.discussions}" var="discussion" rendered="#{not empty searchSuggestion.discussions}">
								<f:facet name="header">
						            #{msg['discussions']}:
						        </f:facet>
						        <h:link outcome="/discussion">
									<span>#{discussion.id}: #{discussion.title}</span>
									<f:param name="id" value="#{discussion.id}"/>
								</h:link>
							</p:dataList>
							<p:dataList value="#{searchSuggestion.comments}" var="comment" rendered="#{not empty searchSuggestion.comments}">
								<f:facet name="header">
						            #{msg['comments']}:
						        </f:facet>
						        <h:link outcome="/commentThread">
									<span>#{comment.id}: #{comment.title}</span>
									<f:param name="id" value="#{comment.id}"/>
								</h:link>
							</p:dataList>
							<p:dataList value="#{searchSuggestion.usernames}" var="username" rendered="#{not empty searchSuggestion.usernames}">
								<f:facet name="header">
						            ${msg['users']}:
						        </f:facet>
						        <h:link outcome="/memberProfile">
									<h:graphicImage value="#{requestContext}/avatar/#{username}" class="w3-circle"
										id="commentorAvatar" height="36" width="36"	title="#{username}"
										rendered="#{fileHandler.isAvatarExists(username)}"/>
									
									<span jsf:rendered="#{!fileHandler.isAvatarExists(username)}" class="w3-circle w3-purple"
										 title="#{username}"
	  									style="display:inline-block;font-size:1.0rem;line-height:36px;width:36px;text-align:center;text-transform: uppercase;">
	  									#{fn:substring(username, 0, 3)}
									</span>
									#{username}
									<f:param name="username" value="#{username}"/>
								</h:link>
							</p:dataList>
						</div>
						
					</div>
				</div>		  	
		  	</div>
		</div>
		
		<!-- Show login and register command link if user is not logged on -->
		<sec:authorize ifAnyGranted="ROLE_ANONYMOUS">
		
			<!-- Login Modal -->
			<div id="loginModal" class="w3-modal">
			  <div class="w3-modal-content w3-card-4 w3-animate-zoom" style="width:450px;max-width:98vw;">
		
				<span onclick="$('#loginModal').hide();" class="w3-button w3-xlarge w3-transparent w3-display-topright" title="#{msg['close']}">&#215;</span>
		
				<header class="w3-container w3-padding w3-center">
					<span class="w3-xlarge"><i class="pi pi-lock w3-xlarge"/> #{msg['login.to']} #{msg['application.title']}</span>
				</header>
				
				<div class="w3-center w3-pale-red" jsf:rendered="#{param.login_error != null and SPRING_SECURITY_LAST_EXCEPTION != null}"
					 style="line-height: 50px;">
					<span class="w3-large">#{SPRING_SECURITY_LAST_EXCEPTION.message}. #{msg['please.try.again']}.</span>
				</div>
				
			    <div class="w3-center w3-section w3-text-theme">
			      	<i class="pi pi-user" style="font-size: 100pt;"/>
			    </div>
			    
    			<form action="#{request.contextPath}/login" method="post" class="w3-container">
    				<div class="w3-section w3-center">
	    				<p>
	    					<input type="text" name="username" placeholder="&#xe939; #{msg['enter.username']}" class="w3-input w3-border w3-round" style="font-family: Helvetica, Arial, sans-serif, PrimeIcons;text-align:center;" />
	    				</p>
	    				<p>
	    					<input type="password" name="password" placeholder="&#xe981; #{msg['enter.password']}" class="w3-input w3-border w3-round" style="font-family: Helvetica, Arial, sans-serif, PrimeIcons;text-align:center;" />
	    				</p>
	    				<p>
	    					<input type="checkbox" name="#{applicationProperties['RememberMe.requestParameter']}" id="#{applicationProperties['RememberMe.requestParameter']}" class="w3-check"/> #{msg['remember.me']}
	    				</p>
	    				<p>
	    					<button type="submit" class="w3-input w3-btn w3-theme-dark w3-round"><i class="pi pi-sign-in"/> #{msg['login']}</button>
	    				</p>
    				</div>
    			</form>
			
			    <div class="w3-container w3-border-top w3-padding-16 w3-theme-light">
			      <span class="w3-left"><a href="#" onclick="$('.w3-modal').hide();$('#registerModal').show();return false;">#{msg['register']}</a></span>
			      <span class="w3-right"><a href="#" onclick="$('.w3-modal').hide();$('#passwordResetModal').show();return false;">#{msg['forgot.password']}</a></span>
			    </div>
			
			  </div>
			  
			</div>
			
			<!-- Register Modal -->
			<div id="registerModal" class="w3-modal">
				<div class="w3-modal-content w3-card-4 w3-animate-zoom" style="width:450px;max-width:98vw;">
		
					<span onclick="$('#registerModal').hide();" class="w3-button w3-xlarge w3-transparent w3-display-topright" title="#{msg['close']}">&#215;</span>
			
					<header class="w3-container w3-padding w3-center">
						<span class="w3-xlarge"><i class="pi pi-book w3-xlarge"/> #{msg['register']}</span>
					</header>
					
					<div class="w3-center w3-section w3-text-theme">
			      		<i class="pi pi-id-card" style="font-size: 100pt;"/>
			    	</div>
							
					<h:form styleClass="w3-container" id="registerForm">
					
						<div jsf:rendered="#{publicBackingBean.registrationSuccess}" class="w3-pale-green w3-container w3-round">
							<div jsf:rendered="#{publicBackingBean.emailSent}">
								<h4>Email has been sent to #{publicBackingBean.user.person.email}</h4>
								<h6>Please find the email and activate your account</h6>
							</div>
							<div jsf:rendered="#{not publicBackingBean.emailSent}">
								<h4>Your account has been created</h4>
								<a href="#" onclick="$('.w3-modal').hide();$('#loginModal').show();return false;">Click here to login</a>
							</div>
						</div>
					
						<div jsf:rendered="#{!publicBackingBean.registrationSuccess and not empty publicBackingBean.registrationMessages}" class="w3-pale-red w3-container w3-round">
							<h4>#{msg['unable.to.create.account']}</h4>
							<ul jsfc="ui:repeat" var="message" value="#{publicBackingBean.registrationMessages}" style="list-style-position: inside; padding-left: 0;">
								<li>#{message}</li>
							</ul>
							
						</div>
					
						<div jsf:rendered="#{!publicBackingBean.registrationSuccess}" class="w3-center">
							<div class="w3-section">
								<p:inputText id="username" value="#{publicBackingBean.user.username}" placeholder="&#xe939; #{msg['pick.a.username']}" styleClass="w3-input" title="#{msg['username']}"
									style="font-family: Helvetica, Arial, sans-serif, PrimeIcons;text-align:center;"
									onblur="validateRegisterUsername();" onfocus="this.className = this.className.replace(/(^|\s)w3-border-\S+/gi, '');"
									validatorMessage="#{msg['username.must.be']}">
									<f:validateRegex pattern="^[a-zA-Z0-9]{5,30}$"/>
								</p:inputText>
								<h:message for="username" id="usernameMessage" errorClass="w3-text-red" infoClass="w3-text-green"/>
							</div>
							<div class="w3-section">
								<p:inputText id="email" value="#{publicBackingBean.user.person.email}" placeholder="@ #{msg['enter.email']}" styleClass="w3-input w3-margin-top" title="#{msg['email']}"
									style="font-family:font-family: Helvetica, Arial, sans-serif, PrimeIcons;text-align:center;"
									onblur="validEmail = validateEmail(this);" onfocus="this.className = this.className.replace(/(^|\s)w3-border-\S+/gi, '');">
								</p:inputText>
								<h:message for="email" id="emailMessage" errorClass="w3-text-red" infoClass="w3-text-green"/>
							</div>
							<div class="w3-section">
								<p:inputText id="firstName" value="#{publicBackingBean.user.person.firstName}" placeholder="&#xe9aa; #{msg['first.name']}" styleClass="w3-input" 
									title="#{msg['first.name']}" style="font-family: Helvetica, Arial, sans-serif, PrimeIcons;text-align:center;" 
									maxlength="30" validatorMessage="#{msg['first.name.cant.exceed.30']}">
									<f:validateLength maximum="30"/>
								</p:inputText>
								<h:message for="firstName" id="firstNameMessage" errorClass="w3-text-red" infoClass="w3-text-green"/>
							</div>
							<div class="w3-section">
								<p:inputText id="lastName" value="#{publicBackingBean.user.person.lastName}" placeholder="&#xe9aa; #{msg['last.name']}" styleClass="w3-input" 
									title="#{msg['last.name']}" style="font-family: Helvetica, Arial, sans-serif, PrimeIcons;text-align:center;"
									maxlength="30" validatorMessage="#{msg['last.name.cant.exceed.30']}">
									<f:validateLength maximum="30"/>
								</p:inputText>
								<h:message for="lastName" id="lastNameMessage" errorClass="w3-text-red" infoClass="w3-text-green"/>					
							</div>
							<div class="w3-section">
								<p:password id="password" value="#{publicBackingBean.user.password}" placeholder="&#xe981; #{msg['choose.a.password']}" styleClass="w3-input" title="#{msg['password']}" 
									style="font-family: Helvetica, Arial, sans-serif, PrimeIcons;text-align:center;" toggleMask="true" validatorMessage="#{msg['password.must.be']}"
									onblur="validateRegisterPassword();" onfocus="this.className = this.className.replace(/(^|\s)w3-border-\S+/gi, '');">
									<f:validateLength minimum="5" maximum="16"/>
								</p:password>
								<h:message for="password" id="passwordMessage" errorClass="w3-text-red" infoClass="w3-text-green"/>
							</div>
							<div class="w3-section">
								<p:password id="confirmPassword" placeholder="&#xe981; #{msg['confirm.password']}" styleClass="w3-input" title="#{msg['confirm.password']}" 
									style="font-family: Helvetica, Arial, sans-serif, PrimeIcons;text-align:center;" toggleMask="true"
									match="password" validatorMessage="#{msg['confirm.password.not.matched']}"
									onblur="validateConfirmPassword();" onfocus="this.className = this.className.replace(/(^|\s)w3-border-\S+/gi, '');">
								</p:password>
								<h:message for="confirmPassword" id="confirmPasswordMessage" errorClass="w3-text-red" infoClass="w3-text-green"/>
							</div>
							<div jsf:rendered="#{publicBackingBean.registrationOption.enableCaptcha}" style="text-align: right;display: flex;" class="w3-section">
								<p:inputText id="captchaInput" placeholder="#{msg['enter.captcha']} &#xe920;" styleClass="w3-input" title="#{msg['captcha']}" 
									style="font-family: Helvetica, Arial, sans-serif, PrimeIcons;text-align:center;flex-grow:1">
									<f:validator validatorId="captchaValidator"/>
								</p:inputText>
								
								<h:graphicImage value="data:image/png;base64,#{captchaImage.randomCaptchaBase64}" id="captchaImage" style="margin-left:5px; border-radius:4px;"/>
								
								<!-- 
									note: it's important to have process="@this" and partialSubmit="true", meaning only process this component (button).
									this would avoid the whole form submit (and the form input validation on the server side):
									
									https://stackoverflow.com/questions/25339056/understanding-primefaces-process-update-and-jsf-fajax-execute-render-attributes
								-->
					  			<p:commandButton update="registerForm:captchaImage" process="@this" partialSubmit="true"
					  				icon="pi pi-refresh" ajax="true" style="margin-left:5px;padding:0 16px;" styleClass="w3-input w3-btn w3-theme-dark" title="#{msg['refresh.captcha']}"/>							
							</div>
							
							<div>
								<h:message for="captchaInput" id="captchaInputMessage" errorClass="w3-text-red" infoClass="w3-text-green"/>
							</div>							
							<div class="w3-section">
								<p:commandButton ajax="true" styleClass="w3-input w3-btn w3-theme-dark" value="&#xe909; #{msg['submit']}" 
									id="submitButton" style="font-family: Helvetica, Arial, sans-serif, PrimeIcons;" action="#{publicBackingBean.register}" update=":registerForm"/>
							</div>
						</div>
					</h:form>
					
				    <div class="w3-container w3-border-top w3-padding-16 w3-theme-light w3-center">
				      
				      <span>
				      	#{msg['already.registered']}?
				      	<a href="#" onclick="$('.w3-modal').hide();$('#loginModal').show();return false;">#{msg['login']}</a>
				      </span>
				      
				    </div>
					
				</div>
			</div>
			
			<!-- Password Reset Modal -->
			<div id="passwordResetModal" class="w3-modal">
				<div class="w3-modal-content w3-card-4 w3-animate-zoom" style="width:450px;max-width:98vw;">

					<span onclick="$('#passwordResetModal').hide();" class="w3-button w3-xlarge w3-transparent w3-display-topright" title="#{msg['close']}">&#215;</span>
		
					<header class="w3-container w3-padding w3-center">
						<span class="w3-xlarge"><i class="pi pi-refresh w3-xlarge"/> #{msg['reset.your.password']} </span>
					</header>

					<div class="w3-center w3-section w3-text-theme">
			      		<i class="pi pi-lock-open" style="font-size:80pt;"/>
			    	</div>
					
					<h:form styleClass="w3-container" id="passwordResetForm">
						
						<div jsf:rendered="#{publicBackingBean.passwordResetEmailSent}" class="w3-pale-green w3-section w3-round w3-center">
							<h4>#{msg['password.reset.email.sent']}</h4>
							<h6>#{msg['please.check.email.for.password.reset.instruction']}</h6>
						</div>
						
						<div jsf:rendered="#{!publicBackingBean.passwordResetEmailSent and not empty publicBackingBean.passwordResetMessages}" class="w3-pale-red w3-section w3-round">
							<h4>#{msg['unable.to.complete.request']}:</h4>
							<ul jsfc="ui:repeat" var="message" value="#{publicBackingBean.passwordResetMessages}" style="list-style-position: inside; padding-left: 0;">
								<li>#{message}</li>
							</ul>
						</div>						

						<div jsf:rendered="#{!publicBackingBean.passwordResetEmailSent}" class="w3-section w3-center">
							
							<h6>#{msg['enter.email.to.get.password.reset.link']}</h6>
							
							<p>
								<p:inputText id="passwordResetEmail" value="#{publicBackingBean.passwordResetEmail}" placeholder="@ #{msg['enter.email']}" styleClass="w3-input w3-margin-top" title="#{msg['email']}"
									style="font-family:Arial, PrimeIcons;text-align:center;"
									onblur="validPasswordResetEmail = validateEmail(this);" onfocus="this.className = this.className.replace(/(^|\s)w3-border-\S+/gi, '');">
								</p:inputText>
								<h:message for="passwordResetEmail" id="passwordResetEmailMessage" errorClass="w3-text-red" infoClass="w3-text-green"/>
							</p>
							<p>
								<p:commandButton ajax="true" styleClass="w3-input w3-btn w3-theme-dark" value="&#xe909; #{msg['submit']}" 
									id="resetPasswordSubmitButton" style="font-family: Helvetica, Arial, sans-serif, PrimeIcons;" action="#{publicBackingBean.resetPassword}" update=":passwordResetForm"/>
							</p>
						</div>
					
					</h:form>

				    <div class="w3-container w3-border-top w3-padding-16 w3-theme-light">
				      <span class="w3-left"><a href="#" onclick="$('.w3-modal').hide();$('#loginModal').show();return false;">#{msg['login']}</a></span>
				      <span class="w3-right"><a href="#" onclick="$('.w3-modal').hide();$('#registerModal').show();return false;">#{msg['register']}</a></span>
				    </div>
					
				</div>
			</div>
			<script>
				//<![CDATA[//------
				
				validPasswordResetEmail = false;
					
				/*
				 *
				 */
				validPassword = false;
				validConfirmPassword = false;
				validEmail = false;
				validUsername = false;
				
				function validateRegisterUsername() {
					
					// https://stackoverflow.com/questions/15933727/javascript-regular-expression-for-usernames-no-spaces
					var userNameRegex = /^[a-zA-Z0-9]{5,30}$/;
					
					var usernameEl = document.getElementById('registerForm:username');
					var username = usernameEl.value;
					
					// reset styling
					usernameEl.className = usernameEl.className.replace(/(^|\s)w3-border-\S+/gi, "");
					
					if(!userNameRegex.test(username)) {
						validUsername = false;
						usernameEl.className += " w3-border-orange";
						usernameEl.title = "#{msg['username.must.be']}"
					}
					else {
						validUsername = true;
						usernameEl.className += " w3-border-light-green";
						usernameEl.title = "#{msg['username']}"
					}
				}
				
				function validateEmail(emailEl) {
					
					var isValid = false;
					
					// the following email regular expression is taken from the most voted answer in stackoverflow at:
					// https://stackoverflow.com/questions/46155/how-to-validate-an-email-address-in-javascript
					var emailRegex =  /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
					
					//var emailEl = document.getElementById('registerForm:email');
					var email = emailEl.value;
					
					// reset styling
					emailEl.className = emailEl.className.replace(/(^|\s)w3-border-\S+/gi, "");
					
					if(!emailRegex.test(String(email).toLowerCase())) {
						isValid = false;
						emailEl.className += " w3-border-orange";
						emailEl.title = "#{msg['invalid.email.format']}"
					}
					else {
						isValid = true;
						emailEl.className += " w3-border-light-green";
						emailEl.title = "#{msg['email']}"
					}
					
					return isValid;
				}
				
				function validateRegisterPassword() {
					
					var passwordEl = document.getElementById('registerForm:password');
					var password = passwordEl.value;
					
					// reset styling
					passwordEl.className = passwordEl.className.replace(/(^|\s)w3-border-\S+/gi, "");
					
					if(password.length < 5 || password.length > 16) {
						validPassword = false;
						passwordEl.className += " w3-border-orange";
						passwordEl.title = "#{msg['password.must.be']}"
					}
					else {
						validPassword = true;
						passwordEl.className += " w3-border-light-green";
						passwordEl.title = "#{msg['password']}"
					}
				}
				
				function validateConfirmPassword() {
					
					var passwordEl = document.getElementById('registerForm:password');
					var password = passwordEl.value;
					
					var confirmPasswordEl = document.getElementById('registerForm:confirmPassword');
					var confirmPassword = confirmPasswordEl.value;
					
					// reset styling
					confirmPasswordEl.className = confirmPasswordEl.className.replace(/(^|\s)w3-border-\S+/gi, "");
					
					if(password != confirmPassword) {
						validConfirmPassword = false;
						confirmPasswordEl.className += " w3-border-orange";
						confirmPasswordEl.title="#{msg['confirm.password.does.not.match.password']}"
					}
					else {
						validConfirmPassword = true;
						confirmPasswordEl.className += " w3-border-light-green";
						confirmPasswordEl.title="#{msg['confirm.password']}"
					}
				}
				
				/*
				 * Note: 04/10/2022: remove the use JS client side validation for now
				 *  validateRegistration() are now not used
				 */ 
				function validateRegistration() {
					
					if(!validUsername) {
						var usernameEl = document.getElementById('registerForm:username');
						var messageEl = document.getElementById('registerForm:usernameMessage');
						messageEl.innerHTML = usernameEl.title;
						messageEl.className += " w3-text-red";
					}
					if(!validEmail) {
						var emailEl = document.getElementById('registerForm:email');
						var messageEl = document.getElementById('registerForm:emailMessage');
						messageEl.innerHTML = emailEl.title;
						messageEl.className += " w3-text-red";
					}
					if(!validPassword) {
						var passwordEl = document.getElementById('registerForm:password');
						var messageEl = document.getElementById('registerForm:passwordMessage'); 
						messageEl.innerHTML = passwordEl.title; 
						messageEl.className += " w3-text-red";
					}
					if(!validConfirmPassword) {
						var confirmPasswordEl = document.getElementById('registerForm:confirmPassword');
						var messageEl = document.getElementById('registerForm:confirmPasswordMessage');
						messageEl.innerHTML = confirmPasswordEl.title; 
						messageEl.className += " w3-text-red";
					}
					
					return validUsername && validEmail && validPassword && validConfirmPassword;
				}
				
				//]]>	
			</script>		
		
		</sec:authorize>
    
        <!-- Page Container -->
		<div class="w3-container w3-content" style="max-width:1680px;margin-top:60px; padding:0px;">
			<!-- The Grid -->
  			<div class="w3-row"> <!-- The w3-row class creates a mobile-first responsive grid system -->
				
				<ui:insert name="content">
                	Template
            	</ui:insert>
            	
			</div> <!-- end of w3-row -->
			
			<!-- bottom copyright -->
			<div class="w3-section w3-center"> 
				<a href="https://github.com/chipolaris/BootForum">BootForum</a>. 
				Powered by <a href="https://www.oracle.com/technetwork/java/javase/overview/index.html">Java</a>, 
				<a href="https://spring.io/projects/spring-boot">Spring Boot</a>, <a href="http://www.eclipse.org/eclipselink/">EclipseLink</a>, 
				<a href="https://www.primefaces.org">Primefaces</a>, and <a href="https://www.w3schools.com/w3css/default.asp">W3.CSS</a>
			</div>
		
		</div> <!-- end of w3-container -->
    	
		<!-- <ui:include src="/WEB-INF/template/about.xhtml"/> -->

        <p:ajaxStatus style="width:32px;height:32px;position:fixed;right:25px;bottom:25px">
            <f:facet name="start">
                <i class="pi pi-spin pi-spinner w3-xxlarge w3-text-blue-grey"/>
            </f:facet>

            <f:facet name="complete">
                <h:outputText value="" />
            </f:facet>
        </p:ajaxStatus>
        <!-- 
        	Note on <ui:include> tag: https://www.illucit.com/en/java-ee/stackoverflow-in-tomcat-8-5-and-9-0/
         -->
        <ui:include src="/WEB-INF/template/ajaxErrors.xhtml" />
    
    </h:body>
</html>